Below is a detailed, engineering-focused plan to make QTC P2P nodes quantum-safe using a PQ Noise-only transport (no │
│ classical fallback), tailored for a Bitcoin Core–style codebase located under bitcoin/. I’ll assume Nodes2.txt       │
│ specifies the intent to (1) adopt a Kyber-based Noise-like KEM handshake, (2) use Dilithium as the node static       │
│ identity, (3) derive AEAD transport keys via SHA3-512 HKDF, and (4) enforce PQ-only (no classical DH or TLS          │
│ fallback).                                                                                                           │
│                                                                                                                      │
│ High-level: Why PQ Noise-only matters                                                                                │
│                                                                                                                      │
│  • Today’s common P2P transports (even BIP324 v2) use classical DH and are not post-quantum. Even if QTC’s on-chain  │
│    signatures/mining are PQ, a quantum adversary could record traffic now and decrypt later.                         │
│  • A PQ Noise-only handshake using Kyber KEM (for forward secrecy through KEM encaps/decaps) and a Dilithium signed  │
│    transcript (for identity authenticity) gives you end-to-end, encryption-in-motion quantum resilience.             │
│  • “Only” means we do not offer classical fallback in production; on dev/test networks you can leave a transitional  │
│    flag to ease debugging.                                                                                           │
│                                                                                                                      │
│ Plan structure                                                                                                       │
│                                                                                                                      │
│  • Phase 0: Confirm requirements from Nodes2.txt and repository layout                                               │
│  • Phase 1: Crypto plumbing and Noise state machine                                                                  │
│  • Phase 2: P2P integration (net/, net_processing/), wire format and feature negotiation                             │
│  • Phase 3: Key management & rotation                                                                                │
│  • Phase 4: Testing (unit, integration, fuzz) and instrumentation                                                    │
│  • Phase 5: Seed domain & seeder deployment                                                                          │
│  • Phase 6: Operational assets: regtest 3-node launcher, configs, CI                                                 │
│  • Phase 7: Rollout strategy (testnet, then mainnet)                                                                 │
│  • Phase 8: Documentation                                                                                            │
│                                                                                                                      │
│ PHASE 0 — Confirm requirements and file layout (1–2 days)                                                            │
│                                                                                                                      │
│  • Requirements from Nodes2.txt:                                                                                     │
│     • PQ Noise-only transport.                                                                                       │
│     • KEM: CRYSTALS-Kyber1024 (32-byte shared secret, 1.5 KB ciphertext).                                            │
│     • Node identity: Dilithium3 static key (pub ~1952B, sig ~3293B).                                                 │
│     • KDF: HKDF-SHA3-512 for deriving transport keys (key_in, key_out, nonce_base).                                  │
│     • AEAD: ChaCha20-Poly1305 or AES-GCM; choose ChaCha20-Poly1305 for simplicity and CPU-friendliness.              │
│     • Rekey: every 32 MB or 30 min; re-encapsulate to a rotating server KEM pk (daily).                              │
│     • PQ only: disable classical fallback in production; allow local override flag for debug.                        │
│  • Repository targets (bitcoin/):                                                                                    │
│     • crypto/kyber/ and crypto/dilithium/ already exist; add thin wrappers if needed.                                │
│     • Create a new pqnoise submodule under src/net/pqnoise.                                                          │
│                                                                                                                      │
│ PHASE 1 — Crypto plumbing and Noise state machine (1–2 weeks) A. Define suite and primitives                         │
│                                                                                                                      │
│  • Suite name: "NoisePQ_KYBER1024_DILITHIUM3_SHA3-512_CHACHA20-POLY1305"                                             │
│  • KEM: Kyber1024 (Encaps/Decaps)                                                                                    │
│  • Sig: Dilithium3 (Sign/Verify)                                                                                     │
│  • Hash/KDF: SHA3-512 (HKDF-SHA3-512)                                                                                │
│  • AEAD: ChaCha20-Poly1305                                                                                           │
│                                                                                                                      │
│ B. Message flow (Noise-like)                                                                                         │
│                                                                                                                      │
│  • ClientHello:                                                                                                      │
│     • client_random (32 bytes)                                                                                       │
│     • client_capabilities (bitfield)                                                                                 │
│     • optional client static sig (for mutual auth, optional)                                                         │
│  • ServerHello:                                                                                                      │
│     • server_random (32 bytes)                                                                                       │
│     • selected_suite (enum)                                                                                          │
│     • server_static_id_sig (Dilithium3 signature over transcript: client_random || server_random || suite)           │
│     • server_kem_pk (Kyber pk) or server_kem_pk_id if pk is cached                                                   │
│  • Client KEM:                                                                                                       │
│     • kem_ct = Kyber.Encaps(server_kem_pk).ciphertext                                                                │
│     • client_ephemeral_tags (optional)                                                                               │
│  • Server KEM:                                                                                                       │
│     • kem_ss = Kyber.Decaps(kem_ct)                                                                                  │
│     • Both sides derive AEAD keys: secret = HKDF-SHA3-512(kem_ss || transcript_hash) key_in, key_out, nonce_base =   │
│       Expand(secret)                                                                                                 │
│     • Switch to AEAD and run encrypted transport.                                                                    │
│                                                                                                                      │
│ C. State machine and transcript                                                                                      │
│                                                                                                                      │
│  • Maintain a transcript hash (SHA3-512) updated with all handshake messages and context.                            │
│  • Sign the transcript with Dilithium3 on the server side for authenticity.                                          │
│  • Consider mutual auth for trusted clusters (optional): client signs transcript too.                                │
│                                                                                                                      │
│ D. Rekeying                                                                                                          │
│                                                                                                                      │
│  • After N bytes or M minutes (configurable), re-encapsulate:                                                        │
│     • Client sends new encaps to current (or updated) server_kem_pk under AEAD.                                      │
│     • Both sides derive fresh keys.                                                                                  │
│                                                                                                                      │
│ E. Implementation files                                                                                              │
│                                                                                                                      │
│  • src/net/pqnoise/pqnoise_state.h/.cpp                                                                              │
│     • class PQNoiseHandshake (roles: Client/Server)                                                                  │
│     • Transcript hashing; KEM encaps/decaps; key derivation.                                                         │
│  • src/crypto/pq_kem.h/.cpp                                                                                          │
│     • Thin wrappers around Kyber1024 (Encaps, Decaps, PK/SK load/store)                                              │
│  • src/crypto/pq_sig.h/.cpp                                                                                          │
│     • Thin wrappers around Dilithium3 (Sign, Verify)                                                                 │
│                                                                                                                      │
│ PHASE 2 — P2P integration (2 weeks) A. Feature negotiation & flags                                                   │
│                                                                                                                      │
│  • In protocol version negotiation (e.g., src/protocol.h, net_processing.cpp):                                       │
│     • Advertise/require a “QTC_PQNOISE” feature bit.                                                                 │
│     • For prod: -pqonly=1 cause the node to refuse non-PQ peers.                                                     │
│     • For dev: -allowlegacy=1 to test classical path locally.                                                        │
│                                                                                                                      │
│ B. Wire format and framing                                                                                           │
│                                                                                                                      │
│  • Option 1: Reuse BIP324 v2 frame structure but feed PQ keys for AEAD; set an "encryption suite" ID to PQ Noise.    │
│  • Option 2: Define a minimal new frame header: {length, nonce, tag}, payload encrypted under key_in/out and         │
│    monotonically increasing nonces.                                                                                  │
│                                                                                                                      │
│ C. Net layer integration                                                                                             │
│                                                                                                                      │
│  • src/net.h/net.cpp:                                                                                                │
│     • Create a PQNoiseTransport class implementing ITransport (or equivalent), wrapping read/write with AEAD.        │
│     • Hook handshake after socket connect/accept; on success, replace plaintext socket read/write with the AEAD      │
│       wrapper.                                                                                                       │
│                                                                                                                      │
│ D. Error handling & DoS                                                                                              │
│                                                                                                                      │
│  • Bound handshake payloads; timeouts on each step.                                                                  │
│  • Max message sizes; early abort on invalid signature or KEM decapsulation failure.                                 │
│                                                                                                                      │
│ PHASE 3 — Key management & rotation (1–2 weeks) A. Identity keys (Dilithium3)                                        │
│                                                                                                                      │
│  • Generated once per node; stored at datadir:                                                                       │
│     • datadir/pqnoise/id_dilithium.sk, id_dilithium.pk                                                               │
│  • NodeID fingerprint: SHA3-256(pk)[:20] (for peer UI/debug)                                                         │
│  • Rotate annually or on demand; maintain allowlist for local trusted peers.                                         │
│                                                                                                                      │
│ B. Server KEM keys (Kyber1024)                                                                                       │
│                                                                                                                      │
│  • Rotate daily:                                                                                                     │
│     • datadir/pqnoise/kem_sk, kem_pk; maintain kem_pk_prev for overlap.                                              │
│  • Publish kem_pk over P2P (Hello) or sign kem_pk digests out-of-band.                                               │
│                                                                                                                      │
│ C. Rekey policy (transport)                                                                                          │
│                                                                                                                      │
│  • Trigger rekey after 32 MB or 30 minutes (configurable). Controlled by PQNoiseTransport.                           │
│                                                                                                                      │
│ PHASE 4 — Testing and instrumentation (1–2 weeks) A. Unit tests (src/test)                                           │
│                                                                                                                      │
│  • pqnoise_handshake_tests.cpp:                                                                                      │
│     • Client/server state machines; transcript; sign/verify; KEM success/failure; rekey.                             │
│  • AEAD fuzz tests & negative tests (bad tags, replay nonces).                                                       │
│                                                                                                                      │
│ B. Functional tests (test/functional)                                                                                │
│                                                                                                                      │
│  • Two nodes negotiate PQ Noise and exchange encrypted messages.                                                     │
│  • Rekey dynamic: send large payload and watch rekey happen (logs).                                                  │
│  • Strict flags:                                                                                                     │
│     • Node with -pqonly=1 rejects a classical peer.                                                                  │
│                                                                                                                      │
│ C. Logging/metrics                                                                                                   │
│                                                                                                                      │
│  • Add logging for handshake stage & suite used.                                                                     │
│  • Expose counters via RPC getnetworkinfo: pq_suites_used, bytes_encrypted, rekeys.                                  │
│                                                                                                                      │
│ PHASE 5 — Seed domain & seeder deployment (1–2 weeks) A. Seed domains                                                │
│                                                                                                                      │
│  • seed1.qtc.org / seed2.qtc.org / seed3.qtc.org with A/AAAA records, geographically distributed.                    │
│                                                                                                                      │
│ B. Seeder options                                                                                                    │
│                                                                                                                      │
│  • Modified bitcoin-seeder:                                                                                          │
│     • Crawl using PQ Noise handshake (set suite; fallback disabled).                                                 │
│     • Serve DNS results with a rolling set of reachable nodes.                                                       │
│  • Lightweight Python crawler (for bootstrap):                                                                       │
│     • Crawl addrs, try PQ Noise handshake, write peers.json.                                                         │
│     • A simple authoritative DNS responder (tinydns/bind module) pulls from peers.json.                              │
│                                                                                                                      │
│ C. Ops checklist                                                                                                     │
│                                                                                                                      │
│  • Uptime monitoring, peer counts, connection success rates, bandwidth.                                              │
│                                                                                                                      │
│ PHASE 6 — Operational assets: regtest & CI (1 week) A. Regtest 3-node launcher                                       │
│                                                                                                                      │
│                                                                                                                      │
│  • Script provided earlier; adapt to require pqonly=1 to exercise PQ handshake locally:                              │
│     • Add flags: -pqonly=1 -listen=1 -discover=0                                                                     │
│     • Node2/Node3 use addnode=127.0.0.1:                                                                             │
│                                                                                                                      │
│ B. CI workflow (already provided)                                                                                    │
│                                                                                                                      │
│  • Builds, runs unit and functional tests, archives JSON artifacts.                                                  │
│  • Add job to run at least one PQ handshake functional test when implemented.                                        │
│                                                                                                                      │
│ PHASE 7 — Rollout: testnet then mainnet                                                                              │
│                                                                                                                      │
│  • Testnet:                                                                                                          │
│     • 3–5 seeders PQ-only.                                                                                           │
│     • PQ handshake default on; classical disabled by default (toggle for debugging).                                 │
│  • Mainnet:                                                                                                          │
│     • 5–10 seeders PQ-only, distributed across orgs.                                                                 │
│     • Documentation for bootstrap and connecting with -pqonly nodes.                                                 │
│                                                                                                                      │
│ PHASE 8 — Documentation                                                                                              │
│                                                                                                                      │
│  • docs/pqnoise_transport.md:                                                                                        │
│     • Suite, wire format, handshake, message flow diagrams, transcript rules, message sizes.                         │
│  • docs/seeders.md:                                                                                                  │
│     • Seed domains, seeder deployment, crawler details, monitoring, rotation.                                        │
│  • docs/dev_regtest.md:                                                                                              │
│     • 3-node launcher usage, pqonly flag, addnode graph.                                                             │
│                                                                                                                      │
│ Message flow diagrams (ASCII)                                                                                        │
│                                                                                                                      │
│ Client                         Server                                                                                │
│                                                                                                                      │
│ ──────────────────────────────────────────────────────────────────────────────────────────────────────────────────── │
│ ClientHello: client_random suites=[NoisePQ...] caps -----------------------------> ServerHello: server_random        │
│ selected_suite server_static_id_sig (Dilithium) server_kem_pk (Kyber) <------------------------------ KEM: kem_ct =  │
│ Encaps(server_kem_pk) -----------------------------> kem_ss = Decaps(kem_ct) secret =                                │
│ HKDF-SHA3-512(kem_ss||transcript) derive {key_in,key_out,nonce_base} Both switch to AEAD (ChaCha20-Poly1305) for     │
│ transport                                                                                                            │
│                                                                                                                      │
│ Rekey:                                                                                                               │
│                                                                                                                      │
│  • After N bytes / M minutes: Client sends new kem_ct under AEAD Both sides derive fresh keys from new kem_ss        │
│                                                                                                                      │
│ Security considerations                                                                                              │
│                                                                                                                      │
│  • No classical fallback: production nodes must reject non-PQ peers (unless explicitly configured).                  │
│  • Identity: bind server Dilithium signature to transcript and suite; log fingerprint to avoid MITM.                 │
│  • KEM key disclosure policy: rotate daily and never reuse decapsulated shared secrets across sessions.              │
│  • Denial of Service: cap handshake sizes, strict timeouts, reject invalid signatures/kem_ct quickly.                │
│                                                                                                                      │
│ Turning Bitcoin Core into QTC Core — concrete file workstreams                                                       │
│                                                                                                                      │
│  • src/crypto:                                                                                                       │
│     • Ensure Kyber and Dilithium wrappers are present and have deterministic APIs: keygen, sign/verify,              │
│       encaps/decaps.                                                                                                 │
│  • src/net/pqnoise:                                                                                                  │
│     • New: PQNoiseHandshake, PQNoiseTransport classes (state machine + AEAD framed transport).                       │
│  • src/net.h/.cpp, src/net_processing.cpp, src/protocol.h:                                                           │
│     • Feature flag negotiation, new transport switch, logs, capability advertisement.                                │
│  • src/script/interpreter.cpp:                                                                                       │
│     • Already controlling witness version v1 and PQ signature verify (Dilithium) for script path.                    │
│  • src/key_io.cpp:                                                                                                   │
│     • Already updated: canonical address encoding to bech32m v1 + 20-byte program via SHA3-256(pubkey).              │
│  • test/unit:                                                                                                        │
│     • pqnoise_handshake_tests.cpp, aead_tests.cpp, hkdf_sha3_tests.cpp.                                              │
│  • test/functional:                                                                                                  │
│     • qtc_pq_handshake.py (two nodes handshake PQ-only).                                                             │
│     • qtc_pq_rekey.py (rekey path validation).                                                                       │
│     • existing compression tests run as part of PQ witness tests.                                                    │
│  • docs:                                                                                                             │
│     • Add pqnoise_transport.md, seeders.md, dev_regtest.md.    